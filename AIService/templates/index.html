<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo 5 V√≤ng Ph·ªèng V·∫•n (Speech-to-Text)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f7f9; color: #333; }
        h1 { color: #1a73e8; text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .container { background-color: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1); }
        button { padding: 12px 20px; background-color: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 15px; font-size: 1em; }
        button:hover:not(:disabled) { background-color: #145cb0; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        select, textarea { padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em; box-sizing: border-box; margin-top: 5px; width: 100%; }
        .question-box { background-color: #e6f7ff; border: 1px solid #91d5ff; padding: 20px; margin-top: 20px; border-radius: 8px; font-size: 1.1em; line-height: 1.6; }
        .result-box { margin-top: 10px; padding: 15px; border-radius: 6px; background-color: #f8f9fa; white-space: pre-wrap; border-left: 5px solid #1a73e8; min-height: 50px; font-size: 0.95em; }
        .round-info { font-weight: bold; color: #d9534f; margin-bottom: 15px; }
        #resultsArea { border-top: 2px solid #eee; margin-top: 20px; padding-top: 20px; }
        .record-button-group { display: flex; align-items: center; gap: 10px; }
        #recordButton { background-color: #dc3545; }
        #recordButton:hover { background-color: #c82333; }
        #micStatus { font-size: 1em; color: #dc3545; display: none; }
        .mic-active { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ Demo Ph·ªèng V·∫•n 5 V√≤ng (Speech-to-Text)</h1>
        
        <div id="setupArea">
            <h2>1. Thi·∫øt l·∫≠p V·ªã tr√≠ & Ng√†nh:</h2>
            
            <label for="interviewTopic">Ch·ªçn V·ªã tr√≠:</label>
            <select id="interviewTopic">
                {% for topic in topics %}
                    <option value="{{ topic }}">{{ topic }}</option>
                {% endfor %}
            </select>
            
            <label for="industryFilter" style="margin-top: 15px; display: block;">Ch·ªçn Ng√†nh:</label>
            <select id="industryFilter">
                {% for industry in industries %}
                    <option value="{{ industry }}">{{ industry }}</option>
                {% endfor %}
            </select>
            
            <button onclick="startInterview()">B·∫Øt ƒë·∫ßu Ph·ªèng v·∫•n (5 C√¢u h·ªèi)</button>
        </div>

        <div id="interviewArea" style="display: none;">
            <p class="round-info"><span id="currentRoundDisplay">V√≤ng 1</span> / <span id="totalRoundsDisplay">5</span></p>

            <h2>C√¢u h·ªèi AI:</h2>
            <div id="questionArea" class="question-box"></div>
            <input type="hidden" id="currentRoundValue" value="1">

            <h2>C√¢u Tr·∫£ L·ªùi c·ªßa B·∫°n: (Ghi √¢m ho·∫∑c Nh·∫≠p)</h2>
            <textarea id="userAnswer" rows="8" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi ho·∫∑c nh·∫•n GHI √ÇM..."></textarea>
            
            <div class="record-button-group">
                <button id="recordButton" onclick="toggleRecording()" type="button">üéôÔ∏è GHI √ÇM C√ÇU TR·∫¢ L·ªúI</button>
                <span id="micStatus" style="display: none;">ƒêang nghe... üî¥</span>
            </div>
            
            <button onclick="submitAnswer()" style="width: 100%;">G·ª≠i C√¢u Tr·∫£ L·ªùi & Ti·∫øp t·ª•c</button>
            <hr>

            <div id="resultsArea">
                <h3>Ph·∫£n h·ªìi V√≤ng Tr∆∞·ªõc (<span id="prevRoundDisplay">Ch∆∞a c√≥</span>)</h3>
                <p><strong>B√°o c√°o ƒê√°nh gi√° (Report):</strong></p>
                <div id="reportResult" class="result-box">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>

                <p><strong>Ph·∫£n h·ªìi & C·∫£i thi·ªán (Feedback):</strong></p>
                <div id="feedbackResult" class="result-box">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>

                <p><strong>C√¢u Tr·∫£ L·ªùi M·∫´u:</strong></p>
                <div id="suggestedAnswerResult" class="result-box">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
            </div>
        </div>

        <div id="finalReportArea" style="display: none;">
            <h2>‚úÖ PH·ªéNG V·∫§N HO√ÄN T·∫§T!</h2>
            <p id="finalMessage" style="font-size: 1.1em; color: green;"></p>
            <button onclick="window.location.reload()">B·∫Øt ƒë·∫ßu Phi√™n m·ªõi</button>
        </div>
    </div>

    <script>
        let totalRounds = 5;
        // Kh·ªüi t·∫°o SpeechRecognition
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        let isRecording = false;
        
        if (recognition) {
            recognition.continuous = true; // Ti·∫øp t·ª•c l·∫Øng nghe cho ƒë·∫øn khi d·ª´ng
            recognition.interimResults = true; // Cho ph√©p hi·ªÉn th·ªã k·∫øt qu·∫£ t·∫°m th·ªùi
            recognition.lang = 'vi-VN'; // ƒê·∫∑t ng√¥n ng·ªØ sang Ti·∫øng Vi·ªát
            
            recognition.onstart = function() {
                isRecording = true;
                document.getElementById('recordButton').textContent = '‚èπÔ∏è D·ª™NG GHI √ÇM';
                document.getElementById('recordButton').style.backgroundColor = '#007bff';
                document.getElementById('micStatus').style.display = 'inline';
            };

            recognition.onresult = function(event) {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£ t·∫°m th·ªùi (n·∫øu c√≥)
                const currentText = document.getElementById('userAnswer').value.trim();
                
                // N·∫øu c√≥ k·∫øt qu·∫£ cu·ªëi c√πng, n·ªëi v√†o vƒÉn b·∫£n hi·ªán t·∫°i
                if (finalTranscript.trim().length > 0) {
                     // N·∫øu textbox kh√¥ng r·ªóng, th√™m d·∫•u c√°ch/xu·ªëng d√≤ng tr∆∞·ªõc khi n·ªëi
                    const separator = currentText.length > 0 && !currentText.endsWith('.') ? '. ' : '';
                    document.getElementById('userAnswer').value = currentText + separator + finalTranscript.trim();
                }
                
                // C·∫≠p nh·∫≠t k·∫øt qu·∫£ t·∫°m th·ªùi (Interim) (Kh√¥ng b·∫Øt bu·ªôc, nh∆∞ng gi√∫p ng∆∞·ªùi d√πng th·∫•y ƒëang nghe)
                document.getElementById('micStatus').textContent = interimTranscript || 'ƒêang nghe... üî¥';
            };

            recognition.onend = function() {
                isRecording = false;
                document.getElementById('recordButton').textContent = 'üéôÔ∏è GHI √ÇM C√ÇU TR·∫¢ L·ªúI';
                document.getElementById('recordButton').style.backgroundColor = '#dc3545';
                document.getElementById('micStatus').style.display = 'none';
            };

            recognition.onerror = function(event) {
                console.error('L·ªói nh·∫≠n d·∫°ng gi·ªçng n√≥i:', event.error);
                if (event.error === 'not-allowed') {
                    alert('L·ªói: B·∫°n c·∫ßn c·∫•p quy·ªÅn truy c·∫≠p microphone cho tr√¨nh duy·ªát.');
                } else if (event.error !== 'no-speech') {
                    alert('L·ªói ghi √¢m: ' + event.error + '. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            };
        } else {
            document.getElementById('recordButton').disabled = true;
            document.getElementById('recordButton').textContent = '‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Ghi √¢m';
        }
        
        function toggleRecording() {
            if (!recognition) return;

            if (isRecording) {
                recognition.stop();
            } else {
                // X√≥a n·ªôi dung c≈© khi b·∫Øt ƒë·∫ßu ghi √¢m m·ªõi
                // document.getElementById('userAnswer').value = ''; 
                recognition.start();
            }
        }
        
        // --- C√ÅC H√ÄM C≈® (START/SUBMIT) GI·ªÆ NGUY√äN ---
        
        async function startInterview() {
            const topic = document.getElementById('interviewTopic').value;
            const industryFilter = document.getElementById('industryFilter').value;
            
            if (isRecording) recognition.stop(); // D·ª´ng ghi √¢m n·∫øu ƒëang ho·∫°t ƒë·ªông

            try {
                const response = await fetch('/start_interview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: topic, industry_filter: industryFilter })
                });
                const data = await response.json();
                
                if (data.error) {
                    alert('L·ªói: ' + data.error);
                    return;
                }

                totalRounds = data.total_rounds;

                document.getElementById('setupArea').style.display = 'none';
                document.getElementById('interviewArea').style.display = 'block';
                
                updateUI(data.current_round, data.question);
                
                document.getElementById('reportResult').textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu.';
                document.getElementById('feedbackResult').textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu.';
                document.getElementById('suggestedAnswerResult').textContent = 'Ch∆∞a c√≥ d·ªØ li·ªáu.';
                document.getElementById('prevRoundDisplay').textContent = 'Ch∆∞a c√≥';

            } catch (error) {
                alert('L·ªói kh·ªüi t·∫°o phi√™n. Vui l√≤ng ki·ªÉm tra console.');
                console.error(error);
            }
        }

        async function submitAnswer() {
            if (isRecording) recognition.stop(); // D·ª´ng ghi √¢m tr∆∞·ªõc khi g·ª≠i
            
            const answer = document.getElementById('userAnswer').value;
            const currentRound = parseInt(document.getElementById('currentRoundValue').value);
            
            if (!answer.trim()) {
                alert('Vui l√≤ng nh·∫≠p ho·∫∑c ghi √¢m c√¢u tr·∫£ l·ªùi c·ªßa b·∫°n.');
                return;
            }

            document.getElementById('reportResult').textContent = 'ƒêang x·ª≠ l√Ω feedback...';
            document.getElementById('feedbackResult').textContent = 'ƒêang x·ª≠ l√Ω feedback...';
            document.getElementById('suggestedAnswerResult').textContent = 'ƒêang x·ª≠ l√Ω feedback...';
            document.querySelector('#interviewArea button:last-of-type').disabled = true;

            try {
                const response = await fetch('/submit_round', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ round: currentRound, answer: answer })
                });
                const data = await response.json();
                
                if (data.error) {
                    alert('L·ªói x·ª≠ l√Ω v√≤ng: ' + data.error);
                    return;
                }

                displayResults(currentRound, data.report, data.feedback, data.suggested_answer);

                if (data.status === 'finished') {
                    document.getElementById('interviewArea').style.display = 'none';
                    document.getElementById('finalReportArea').style.display = 'block';
                    document.getElementById('finalMessage').textContent = data.final_report;
                } else if (data.status === 'next_round') {
                    updateUI(data.current_round, data.next_question);
                }
            } catch (error) {
                alert('L·ªói g·ª≠i c√¢u tr·∫£ l·ªùi. Vui l√≤ng ki·ªÉm tra console.');
                console.error(error);
            } finally {
                document.querySelector('#interviewArea button:last-of-type').disabled = false;
            }
        }

        function updateUI(round, question) {
            document.getElementById('currentRoundDisplay').textContent = `V√≤ng ${round}`;
            document.getElementById('totalRoundsDisplay').textContent = totalRounds;
            document.getElementById('currentRoundValue').value = round;
            document.getElementById('questionArea').textContent = question;
            document.getElementById('userAnswer').value = '';
        }

        function displayResults(round, report, feedback, suggested) {
            document.getElementById('prevRoundDisplay').textContent = `V√≤ng ${round}`;
            document.getElementById('reportResult').textContent = report.trim();
            document.getElementById('feedbackResult').textContent = feedback.trim();
            document.getElementById('suggestedAnswerResult').textContent = suggested.trim();
        }
    </script>
</body>
</html>